<!DOCTYPE html>
<script src="polyfill.js"></script>
<script>
'use strict';

function sleep(ms) {
  return new Promise(function(resolve) {
    setTimeout(resolve, ms);
  });
}

var r = indexedDB.open('db' + Date.now());
r.onupgradeneeded = function() {
  var db = r.result;
  var s = db.createObjectStore('squares');
  for (var i = 0; i < 10; ++i) {
    s.put(i * i, i);
  }
};

r.onsuccess = function() {
  var db = r.result;
  console.log('-- creating tx --');
  var tx = db.transaction('squares');
  var s = tx.objectStore('squares');
  console.log('state >> ' + tx.state);

  (function() {
    console.assert(tx.promise === tx.promise);

    var rq = s.get(0);
    console.assert(rq.promise === rq.promise);
  }());

  var rq, rq2, p2;
  tx.waitUntil(
    rq = s.get(3).promise
     .then(function(result) {
       console.log('tx state >> ' + tx.state);
       console.log('result >> ' + result);
       return sleep(10);
     })
     .then(function() {
       console.log('tx state >> ' + tx.state);
       rq2 = s.get(5);
       p2 = rq2.promise;
       return p2;
     })
     .then(function(result) {
       console.assert(p2 === rq2.promise);
       console.log('tx state >> ' + tx.state);
       console.log('result >> ' + result);
       return sleep(10);
     })
  );

  tx.promise.then(function() {
    console.log('tx then, state >> ' + tx.state);
  }, function() {
    console.log('tx caught, state >> ' + tx.state);
  });

  sleep(100).then(function() {
    console.log('-- creating tx2 --');
    var tx2 = db.transaction('squares');
    var store = tx2.objectStore('squares');
    console.log('tx2 state >> ' + tx2.state);
    var spin = true;
    (function wait() {
      if (spin)
        store.get(0).onsuccess = wait;
      else
        console.log('tx2 state >> ' + tx2.state);
    }());
    setTimeout(function() {
      console.log('tx2 state >> ' + tx2.state);
      spin = false;
    }, 0);
    tx2.oncomplete = function() {
      console.log('tx2 state >> ' + tx2.state);
    };
  });
};

</script>
